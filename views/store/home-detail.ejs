<%- include('../partials/head') %>
<body class="bg-white">
<%- include('../partials/nav') %>

<main class="container mb-5" style="margin-top: 24px;">

  <div class="mb-4">
    <h1 class="listing-title"><%= home.houseName %></h1>
    <div class="d-flex gap-2 text-muted small fw-bold">
      <span>â˜… <%= home.rating %></span>
      <span>â€¢</span>
      <span class="text-decoration-underline"><%= home.location %></span>
    </div>
  </div>

  <div class="photo-grid">
    <img src="<%= home.photoUrl[0] %>" class="photo-main" alt="Main Photo">
    
    <div class="photo-col">
      <img src="<%= home.photoUrl[1] || home.photoUrl[0] %>" class="photo-sub" alt="Photo 2">
      <img src="<%= home.photoUrl[2] || home.photoUrl[0] %>" class="photo-sub" alt="Photo 3">
    </div>
  </div>

  <div class="row mt-5">
    
    <div class="col-lg-8 pe-lg-5">
      
      <div class="d-flex align-items-center justify-content-between py-4 border-bottom">
        <div>
          <h4 class="fw-bold mb-1">Entire home hosted by <%= home.userId.firstName %></h4>
          <p class="text-muted mb-0">4 guests â€¢ 2 bedrooms â€¢ 2 beds â€¢ 2 baths</p>
        </div>
        <div class="rounded-circle bg-dark text-white d-flex align-items-center justify-content-center shadow-sm" 
             style="width: 56px; height: 56px; font-size: 1.5rem; font-weight: bold;">
          <%= home.userId.firstName.charAt(0) %>
        </div>
      </div>

      <div class="py-4 border-bottom">
        <div class="d-flex gap-3 mb-3">
          <svg viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10a2 2 0 0 1 2-2h22a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10z"></path><path d="M13 2v6M19 2v6"></path></svg>
          <div>
            <div class="fw-bold">Designed by experts</div>
            <div class="text-muted small">This home is unique and stylish.</div>
          </div>
        </div>
        <div class="d-flex gap-3">
          <svg viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 29L3 16 16 3l13 13-13 13z"></path></svg>
          <div>
            <div class="fw-bold">Self check-in</div>
            <div class="text-muted small">Check yourself in with the keypad.</div>
          </div>
        </div>
      </div>

      <div class="py-4 border-bottom">
        <p class="lh-lg" style="font-size: 1rem;"><%= home.description %></p>
      </div>

      <div class="py-4 border-bottom">
        <h4 class="fw-bold mb-4">What this place offers</h4>
        <div class="row">
          <% if (home.amenities && home.amenities.length > 0) { %>
            <% home.amenities.forEach(item => { %>
              <div class="col-md-6 amenity-item mb-3">
                <% if(item === 'Wifi') { %> <i class="bi bi-wifi"></i> <% } %>
                <% if(item === 'AC') { %> <i class="bi bi-snow"></i> <% } %>
                <% if(item === 'TV') { %> <i class="bi bi-tv"></i> <% } %>
                <% if(item === 'Pool') { %> <i class="bi bi-water"></i> <% } %>
                <% if(item === 'Parking') { %> <i class="bi bi-car-front"></i> <% } %>
                <% if(item === 'Kitchen') { %> <i class="bi bi-cup-hot"></i> <% } %>
                <% if(item === 'Washer') { %> <i class="bi bi-bucket"></i> <% } %>
                <% if(item === 'Gym') { %> <i class="bi bi-activity"></i> <% } %>
                <span class="ms-2"><%= item %></span>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted">No specific amenities listed.</p>
          <% } %>
        </div>
      </div>

      <div class="py-4">
        <h4 class="fw-bold mb-3">Where you'll be</h4>
        <div id="map" class="rounded-4" style="height: 400px; border: 1px solid #e0e0e0;"></div>
      </div>

    </div>

    <div class="col-lg-4">
      <div class="card border rounded-4 shadow-sm p-4 sticky-top" style="top: 100px;">
        
        <div class="d-flex justify-content-between align-items-end mb-4">
          <div>
             <span class="fs-3 fw-bold">â‚¹<%= home.price %></span> <span class="text-muted">night</span>
          </div>
          <div class="small fw-bold">
             <i class="bi bi-star-fill text-danger"></i> <%= home.rating %> <span class="text-muted text-decoration-underline">Â· 18 reviews</span>
          </div>
        </div>

        <div class="alert alert-light border mb-3 text-center">
            <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Availability</small>
            <div class="d-flex justify-content-center align-items-center gap-2 mt-1">
                 <div class="fw-bold text-dark">
                    <%= home.availableFrom ? home.availableFrom.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Ask Host' %>
                 </div>
                 <span class="text-muted fw-bold">&ndash;</span>
                 <div class="fw-bold text-dark">
                    <%= home.availableTo ? home.availableTo.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Ask Host' %>
                 </div>
            </div>
        </div>

      <form action="/bookings" method="POST">     
           <input type="hidden" name="homeId" value="<%= home._id %>">
            
            <div class="border rounded-4 mb-3">
                <div class="d-flex border-bottom">
                    <div class="w-50 p-2 border-end">
                        <label class="small fw-bold text-uppercase" style="font-size: 0.7rem;">Check-in</label>
                        <input type="date" name="checkIn" class="form-control border-0 p-0 shadow-none" 
                               min="<%= home.availableFrom ? home.availableFrom.toISOString().split('T')[0] : '' %>"
                               max="<%= home.availableTo ? home.availableTo.toISOString().split('T')[0] : '' %>" required>
                    </div>
                    <div class="w-50 p-2">
                        <label class="small fw-bold text-uppercase" style="font-size: 0.7rem;">Check-out</label>
                        <input type="date" name="checkOut" class="form-control border-0 p-0 shadow-none" 
                               min="<%= home.availableFrom ? home.availableFrom.toISOString().split('T')[0] : '' %>"
                               max="<%= home.availableTo ? home.availableTo.toISOString().split('T')[0] : '' %>" required>
                    </div>
                </div>

                <div class="p-2 position-relative">
                    <label class="small fw-bold text-uppercase ps-1" style="font-size: 0.7rem;">Guests</label>
                    
                    <div class="d-flex justify-content-between align-items-center p-1" 
                         style="cursor: pointer;" id="guest-trigger">
                        <span id="guest-label">1 Guest</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>

                    <input type="hidden" name="adults" id="input-adults" value="1">
                    <input type="hidden" name="children" id="input-children" value="0">
                    <input type="hidden" name="seniors" id="input-seniors" value="0">

                    <div id="guest-dropdown" class="position-absolute bg-white shadow-lg rounded-4 p-3 border d-none" 
                         style="top: 100%; left: 0; right: 0; z-index: 1000;">
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div class="fw-bold">Adults</div>
                                <div class="small text-muted">Age 13+</div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <button type="button" class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                        style="width: 32px; height: 32px;" onclick="updateCount('adults', -1)">-</button>
                                <span id="display-adults" class="fw-bold" style="width: 20px; text-align: center;">1</span>
                                <button type="button" class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                        style="width: 32px; height: 32px;" onclick="updateCount('adults', 1)">+</button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div class="fw-bold">Children</div>
                                <div class="small text-muted">Ages 2â€“12</div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <button type="button" class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                        style="width: 32px; height: 32px;" onclick="updateCount('children', -1)">-</button>
                                <span id="display-children" class="fw-bold" style="width: 20px; text-align: center;">0</span>
                                <button type="button" class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                        style="width: 32px; height: 32px;" onclick="updateCount('children', 1)">+</button>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <div class="fw-bold">Seniors</div>
                                <div class="small text-muted">Age 60+</div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <button type="button" class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                        style="width: 32px; height: 32px;" onclick="updateCount('seniors', -1)">-</button>
                                <span id="display-seniors" class="fw-bold" style="width: 20px; text-align: center;">0</span>
                                <button type="button" class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" 
                                        style="width: 32px; height: 32px;" onclick="updateCount('seniors', 1)">+</button>
                            </div>
                        </div>

                        <div class="text-end mt-2">
                             <button type="button" class="btn btn-link text-decoration-none fw-bold text-dark p-0" onclick="toggleGuestMenu()">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary w-100 py-3 fw-bold rounded-3" 
                    style="background: linear-gradient(to right, #E61E4D, #D80565); border: none;">
                Reserve & Pay
            </button>
        </form>
        
        <div class="text-center mt-3 small text-muted">You won't be charged yet</div>

        <div class="mt-4 pt-3 border-top">
            <div class="d-flex justify-content-between fw-bold fs-5">
                <span>Total</span>
                <span>â‚¹<%= home.price %> / night</span>
            </div>
            <div class="text-end small text-muted mt-1">(Final price calculated on boarding pass)</div>
        </div>

        <form action="/favourite-list" method="POST" class="mt-4 text-center">
            <input type="hidden" name="homeId" value="<%= home._id %>">
            <button class="btn btn-link text-muted text-decoration-underline fw-bold btn-sm">
             <i class="bi bi-heart-fill me-1"></i> Save to Wishlist
            </button>
        </form>

      </div>
    </div>
</main>

<script>
  // ðŸŸ¢ MAP LOGIC (Keep existing map code)
  fetch('https://nominatim.openstreetmap.org/search?format=json&q=<%= home.location %>')
    .then(res => res.json())
    .then(data => {
      if (!data || data.length === 0) return;
      const lat = data[0].lat;
      const lon = data[0].lon;
      const map = L.map('map', { scrollWheelZoom: false }).setView([lat, lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      L.circle([lat, lon], { color: '#ff385c', fillColor: '#ff385c', fillOpacity: 0.2, radius: 500 }).addTo(map);
    });

  // ðŸŸ¢ GUEST DROPDOWN LOGIC
  const guestTrigger = document.getElementById('guest-trigger');
  const guestDropdown = document.getElementById('guest-dropdown');
  const guestLabel = document.getElementById('guest-label');

  // Toggle Menu Visibility
  function toggleGuestMenu() {
    guestDropdown.classList.toggle('d-none');
  }

  // Close menu when clicking outside
  document.addEventListener('click', function(e) {
    if (!guestTrigger.contains(e.target) && !guestDropdown.contains(e.target)) {
      guestDropdown.classList.add('d-none');
    }
  });

  guestTrigger.addEventListener('click', toggleGuestMenu);

  // Counters
  const counts = {
    adults: 1,
    children: 0,
    seniors: 0
  };

  function updateCount(type, change) {
    const newVal = counts[type] + change;

    // Validation: Adults min 1, others min 0. Max 10.
    if (type === 'adults' && newVal < 1) return;
    if (newVal < 0) return;
    if (newVal > 10) return;

    // Update State
    counts[type] = newVal;

    // Update UI Number
    document.getElementById(`display-${type}`).innerText = newVal;

    // Update Hidden Input (For Server)
    document.getElementById(`input-${type}`).value = newVal;

    // Update Main Label (e.g., "3 Guests")
    const totalGuests = counts.adults + counts.children + counts.seniors;
    guestLabel.innerText = `${totalGuests} Guest${totalGuests !== 1 ? 's' : ''}`;
  }
</script>
</body>
</html>